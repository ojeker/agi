import ch.so.agi.gretl.tasks.*
import ch.so.agi.gretl.api.*

defaultTasks "last"

def tmpDir = buildDir.toString()
def datPath = tmpDir + "/data.csv"
def schema = "afu_igel_pub_v1"

def dbCon = ['jdbc:postgresql://localhost:54322/pub?currentSchema=public', 'ddluser', 'ddluser']

task generateTestData(type: SqlExecutor){
    doFirst{
        elapsed()
    }
    database = dbCon
    sqlFiles = ['delete.sql','insert.sql']
}

/*
task export(type: ShpExport, dependsOn: generateTestData){
    doFirst{
        elapsed()
    }
    database = dbCon
    schemaName = schema
    tableName = "igel_stall_shp"
    dataFile = datPath
    encoding = "UTF-8"
}
*/ 

task export(type: CsvExport, dependsOn: generateTestData){
    doFirst{
        elapsed()
    }
    database = dbCon
    schemaName = schema
    tableName = "igel_stall_shp"
    dataFile = datPath
    encoding = "UTF-8"
    firstLineIsHeader = true
    valueSeparator = ';'
}

task deleteAfterExport(type: SqlExecutor, dependsOn: export){
    doFirst{
        elapsed()
    }
    database = dbCon
    sqlFiles = ['delete.sql']
}

/*
task import_(type: ShpImport, dependsOn: deleteAfterExport){
    doFirst{
        elapsed()
    }
    database = dbCon
    schemaName = schema
    tableName = "igel_stall_shp"
    dataFile = datPath
    encoding = "UTF-8"
}
*/

task import_(type: CsvImport, dependsOn: deleteAfterExport){
    doFirst{
        elapsed()
    }
    database = dbCon
    schemaName = schema
    tableName = "igel_stall_shp"
    dataFile = datPath
    encoding = "UTF-8"
    firstLineIsHeader = true
    valueSeparator = ';'
}

task last(dependsOn: import_){
    doLast{
        elapsed()
    }
}

project.ext.start = -1
def elapsed() {
    if(project.ext.start == -1)
        project.ext.start = System.currentTimeMillis()

    def sec = Math.round((System.currentTimeMillis() - project.ext.start) / 1000)
    println 'ELAPSED: ' + sec
}
